// Prisma Schema - Auth Service
// Database: cropfresh_auth
// Purpose: User authentication, sessions, roles, farmer profiles, payment details
// Updated: 2025-12-07 for Story 2.1 (10-step onboarding)

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// User Model - Stores all user types (Farmer, Buyer, Hauler, Agent)
model User {
  id           Int      @id @default(autoincrement())
  phone        String   @unique @db.VarChar(15)
  name         String?  @db.VarChar(255)
  role         UserRole
  passwordHash String?  @map("password_hash") @db.VarChar(255)
  language     String?  @default("en") @map("language_preference") @db.VarChar(10)
  isActive     Boolean  @default(true) @map("is_active")

  // Email (Story 2.3 - Buyer Registration)
  email           String?   @unique @db.VarChar(255)
  emailVerified   Boolean   @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at") @db.Timestamptz(6)

  // Alternate Phone (Story 2.5 - AC2: Emergency contact for haulers)
  alternatePhone String? @map("alternate_phone") @db.VarChar(15)

  // PIN Authentication (Story 2.1 - AC8)
  pinHash     String? @map("pin_hash") @db.VarChar(255)
  pinAttempts Int     @default(0) @map("pin_attempts")

  // Password Login Lockout (Story 2.3 - AC8)
  loginAttempts Int       @default(0) @map("login_attempts")
  lockedUntil   DateTime? @map("locked_until") @db.Timestamptz(6)
  lastLoginAt   DateTime? @map("last_login_at") @db.Timestamptz(6)

  // Temporary PIN for Agent First-Time Login (Story 2.6 - AC4)
  temporaryPin String?   @map("temporary_pin") @db.VarChar(255) // bcrypt hash
  pinExpiresAt DateTime? @map("pin_expires_at") @db.Timestamptz(6) // 24hr expiry

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  sessions        Session[]
  farmerProfile   FarmerProfile?
  buyerProfile    BuyerProfile?
  haulerProfile   HaulerProfile? // Story 2.5 - Hauler profile relation
  paymentDetails  PaymentDetails[]
  teamMemberships TeamMembership[] // Story 2.4 - Team memberships
  invitedMembers  TeamInvitation[] @relation("InvitedBy") // Invites sent by this user
  roleChanges     TeamRoleChange[] @relation("ChangedBy") // Role changes made by this user
  agentProfile    AgentProfile?

  @@map("users")
}

// FarmerProfile Model - Extended profile for farmers (Story 2.1 - AC5, AC6)
model FarmerProfile {
  id     Int @id @default(autoincrement())
  userId Int @unique @map("user_id")

  // Personal Info (AC5)
  fullName String  @map("full_name") @db.VarChar(255)
  village  String? @db.VarChar(255)
  taluk    String? @db.VarChar(255)
  district String  @db.VarChar(255)
  state    String  @db.VarChar(255)
  pincode  String? @db.VarChar(10)

  // Farm Info (AC6)
  farmSize     FarmSize @map("farm_size")
  farmingTypes String[] @map("farming_types")
  mainCrops    String[] @map("main_crops")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("farmer_profiles")
}

// BuyerProfile Model - Extended profile for buyers (Story 2.3)
model BuyerProfile {
  id     Int @id @default(autoincrement())
  userId Int @unique @map("user_id")

  // Business Info (Story 2.3 - AC1)
  businessName String       @map("business_name") @db.VarChar(255)
  businessType BusinessType @map("business_type")
  gstNumber    String?      @map("gst_number") @db.VarChar(15)

  // Business Address
  addressLine1 String  @map("address_line1") @db.VarChar(255)
  addressLine2 String? @map("address_line2") @db.VarChar(255)
  city         String  @db.VarChar(100)
  state        String  @db.VarChar(100)
  pincode      String  @db.VarChar(10)

  // Location (optional GPS coordinates)
  latitude  Float?
  longitude Float?

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Story 2.4 - Team management relations
  teamMemberships TeamMembership[]
  teamInvitations TeamInvitation[]

  @@map("buyer_profiles")
}

// PaymentDetails Model - UPI/Bank for farmers (Story 2.1 - AC7)
model PaymentDetails {
  id          Int         @id @default(autoincrement())
  userId      Int         @map("user_id")
  paymentType PaymentType @map("payment_type")

  // UPI Details
  upiId String? @map("upi_id") @db.VarChar(100)

  // Bank Details
  bankAccount String? @map("bank_account") @db.VarChar(20)
  ifscCode    String? @map("ifsc_code") @db.VarChar(11)
  bankName    String? @map("bank_name") @db.VarChar(100)

  // Verification
  isVerified Boolean   @default(false) @map("is_verified")
  verifiedAt DateTime? @map("verified_at") @db.Timestamptz(6)
  isPrimary  Boolean   @default(false) @map("is_primary")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_details")
}

// Session Model - Active user sessions
model Session {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  deviceId     String?   @map("device_id") @db.VarChar(255)
  token        String    @unique @db.VarChar(500)
  refreshToken String?   @map("refresh_token") @db.VarChar(500)
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz(6)
  ipAddress    String?   @map("ip_address") @db.VarChar(45)
  userAgent    String?   @map("user_agent") @db.Text
  revokedAt    DateTime? @map("revoked_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// PasswordResetToken Model - For forgot password flow (Story 2.3 - AC9)
model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  tokenHash String    @unique @map("token_hash") @db.VarChar(255) // bcrypt hash of token
  expiresAt DateTime  @map("expires_at") @db.Timestamptz(6) // 1 hour expiry
  usedAt    DateTime? @map("used_at") @db.Timestamptz(6) // Single-use tracking
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([userId])
  @@map("password_reset_tokens")
}

// Enums

enum UserRole {
  FARMER
  BUYER
  HAULER
  AGENT
  ADMIN
}

// Farm size categories (Story 2.1 - AC6)
enum FarmSize {
  SMALL // <2 acres
  MEDIUM // 2-5 acres
  LARGE // >5 acres
}

// Payment type (Story 2.1 - AC7)
enum PaymentType {
  UPI
  BANK
}

// Business type for buyers (Story 2.3 - AC1)
// 28 types across 7 categories
enum BusinessType {
  // Food Service (7)
  RESTAURANT
  HOTEL
  CATERER
  CANTEEN
  CLOUD_KITCHEN
  CAFE
  FAST_FOOD_CHAIN

  // Retail (5)
  SUPERMARKET
  GROCERY_STORE
  HYPERMARKET
  CONVENIENCE_STORE
  ORGANIC_STORE

  // Wholesale (4)
  WHOLESALER
  DISTRIBUTOR
  COMMISSION_AGENT
  TRADER

  // Processing (4)
  FOOD_PROCESSOR
  JUICE_MANUFACTURER
  FROZEN_FOOD_COMPANY
  PICKLE_MANUFACTURER

  // Export (3)
  EXPORTER
  EXPORT_HOUSE
  INTERNATIONAL_TRADER

  // Institutional (4)
  HOSPITAL
  SCHOOL_COLLEGE
  CORPORATE_CAFETERIA
  GOVERNMENT_INSTITUTION

  // Specialty (1)
  FARM_TO_TABLE
}

// Buyer team role (Story 2.4 - AC2)
enum BuyerTeamRole {
  ADMIN // Full access, user management, payment authorization
  PROCUREMENT_MANAGER // Place orders, view inventory, manage deliveries
  FINANCE_USER // View invoices, payment history (read-only)
  RECEIVING_STAFF // Confirm deliveries, report quality issues
}

// Team membership status (Story 2.4)
enum TeamMemberStatus {
  ACTIVE
  INACTIVE
  PENDING
}

// Team Membership Model - Links users to buyer organizations (Story 2.4)
model TeamMembership {
  id          Int              @id @default(autoincrement())
  buyerOrgId  Int              @map("buyer_org_id") // FK to BuyerProfile
  userId      Int              @map("user_id") // FK to User
  role        BuyerTeamRole
  status      TeamMemberStatus @default(ACTIVE)
  invitedById Int?             @map("invited_by")
  invitedAt   DateTime         @default(now()) @map("invited_at") @db.Timestamptz(6)
  acceptedAt  DateTime?        @map("accepted_at") @db.Timestamptz(6)
  createdAt   DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  buyerOrg    BuyerProfile     @relation(fields: [buyerOrgId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleChanges TeamRoleChange[]

  @@unique([buyerOrgId, userId]) // One membership per user per organization
  @@index([buyerOrgId])
  @@index([userId])
  @@map("team_memberships")
}

// Team Invitation Model - Pending team invitations (Story 2.4 - AC3, AC9)
model TeamInvitation {
  id          Int           @id @default(autoincrement())
  buyerOrgId  Int           @map("buyer_org_id") // FK to BuyerProfile
  email       String        @db.VarChar(255)
  mobile      String        @db.VarChar(15)
  role        BuyerTeamRole
  note        String?       @db.VarChar(200) // Optional custom note (max 200 chars per AC2)
  tokenHash   String        @unique @map("token_hash") @db.VarChar(255) // bcrypt hash of invitation token
  expiresAt   DateTime      @map("expires_at") @db.Timestamptz(6) // 24-hour expiry
  accepted    Boolean       @default(false)
  acceptedAt  DateTime?     @map("accepted_at") @db.Timestamptz(6)
  invitedById Int           @map("invited_by")
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  buyerOrg  BuyerProfile @relation(fields: [buyerOrgId], references: [id], onDelete: Cascade)
  invitedBy User         @relation("InvitedBy", fields: [invitedById], references: [id])

  @@index([buyerOrgId])
  @@index([email])
  @@index([tokenHash])
  @@map("team_invitations")
}

// Team Role Change Audit Model - Tracks role modifications (Story 2.4 - AC6)
model TeamRoleChange {
  id               Int           @id @default(autoincrement())
  teamMembershipId Int           @map("team_membership_id")
  oldRole          BuyerTeamRole @map("old_role")
  newRole          BuyerTeamRole @map("new_role")
  changedById      Int           @map("changed_by")
  reason           String?       @db.VarChar(255)
  changedAt        DateTime      @default(now()) @map("changed_at") @db.Timestamptz(6)

  // Relations
  teamMembership TeamMembership @relation(fields: [teamMembershipId], references: [id], onDelete: Cascade)
  changedBy      User           @relation("ChangedBy", fields: [changedById], references: [id])

  @@index([teamMembershipId])
  @@index([changedById])
  @@map("team_role_changes")
}

// ============ Story 2.5: Hauler Registration Models ============

// Hauler account verification status (AC6, AC7)
enum HaulerStatus {
  PENDING_VERIFICATION // Submitted, awaiting DM review
  ACTIVE // Approved by District Manager
  REJECTED // Rejected with reason
  SUSPENDED // Temporarily suspended
}

// Vehicle type categories with capacity/radius limits (AC3, AC8)
enum VehicleType {
  BIKE // ≤20kg, ≤10km
  AUTO // ≤100kg, ≤30km
  PICKUP_VAN // ≤500kg, ≤80km
  SMALL_TRUCK // ≤2000kg, ≤150km
}

// Document types for hauler verification (AC3, AC4)
enum HaulerDocumentType {
  VEHICLE_PHOTO_FRONT // Required vehicle front view
  VEHICLE_PHOTO_SIDE // Required vehicle side view
  VEHICLE_PHOTO_OTHER // Optional additional photos
  DL_FRONT // Driving license front
  DL_BACK // Driving license back
}

// HaulerProfile Model - Stores vehicle and license details (Story 2.5)
model HaulerProfile {
  id     Int @id @default(autoincrement())
  userId Int @unique @map("user_id")

  // Vehicle Information (AC3)
  vehicleType       VehicleType @map("vehicle_type")
  vehicleNumber     String      @unique @map("vehicle_number") @db.VarChar(20)
  payloadCapacityKg Int         @map("payload_capacity_kg")

  // License Information (AC4)
  dlNumber String   @map("dl_number") @db.VarChar(50)
  dlExpiry DateTime @map("dl_expiry") @db.Date

  // Verification Status (AC6, AC7)
  verificationStatus HaulerStatus @default(PENDING_VERIFICATION) @map("verification_status")
  verifiedById       Int?         @map("verified_by")
  verifiedAt         DateTime?    @map("verified_at") @db.Timestamptz(6)
  rejectionReason    String?      @map("rejection_reason") @db.VarChar(255)

  // Registration Step Tracking
  currentStep       Int     @default(1) @map("current_step") // 1-4 for multi-step flow
  stepCompleted     Boolean @default(false) @map("step_completed")
  registrationToken String? @unique @map("registration_token") @db.VarChar(255) // Temp token for multi-step

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents HaulerDocument[]

  @@index([verificationStatus])
  @@index([vehicleNumber])
  @@map("hauler_profiles")
}

// HaulerDocument Model - Stores references to S3-uploaded documents (AC3, AC4)
model HaulerDocument {
  id         Int                @id @default(autoincrement())
  haulerId   Int                @map("hauler_id")
  docType    HaulerDocumentType @map("document_type")
  storageUrl String             @map("storage_url") @db.VarChar(500)
  fileName   String             @map("file_name") @db.VarChar(255)
  fileSize   Int                @map("file_size") // bytes
  mimeType   String             @map("mime_type") @db.VarChar(50)

  uploadedAt DateTime @default(now()) @map("uploaded_at") @db.Timestamptz(6)

  // Relations
  haulerProfile HaulerProfile @relation(fields: [haulerId], references: [id], onDelete: Cascade)

  @@index([haulerId])
  @@map("hauler_documents")
}

// VehicleEligibility - Lookup table for vehicle capacity/radius limits (AC8)
model VehicleEligibility {
  id            Int         @id @default(autoincrement())
  vehicleType   VehicleType @unique @map("vehicle_type")
  maxCapacityKg Int         @map("max_capacity_kg")
  maxRadiusKm   Int         @map("max_radius_km")
  description   String?     @db.VarChar(100)

  @@map("vehicle_eligibility_rules")
}

// ============ Story 2.6: Field Agent Pre-Provisioned Accounts ============

// Agent account status (AC3, AC5, AC7)
enum AgentStatus {
  TRAINING // Initial status after provisioning
  ACTIVE // Onboarding complete, can access dashboard
  INACTIVE // Deactivated by District Manager
  SUSPENDED // Temporary suspension
}

// Agent employment type (AC2)
enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
}

// Zone hierarchy type (AC2, AC7)
enum ZoneType {
  STATE
  DISTRICT
  TALUK
  VILLAGE
}

// AgentProfile Model - Extended profile for field agents (Story 2.6)
model AgentProfile {
  id             Int            @id @default(autoincrement())
  userId         Int            @unique @map("user_id")
  employeeId     String         @unique @map("employee_id") @db.VarChar(20) // Format: AGT-BLR-001
  employmentType EmploymentType @map("employment_type")
  status         AgentStatus    @default(TRAINING)
  startDate      DateTime       @map("start_date") @db.Date
  createdById    Int            @map("created_by") // District Manager who created

  // Deactivation tracking (AC7)
  deactivatedAt      DateTime? @map("deactivated_at") @db.Timestamptz(6)
  deactivationReason String?   @map("deactivation_reason") @db.VarChar(100)

  // Training completion (AC5)
  trainingCompletedAt DateTime? @map("training_completed_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  zoneAssignments AgentZoneAssignment[]

  @@index([status])
  @@index([employeeId])
  @@map("agent_profiles")
}

// Zone Model - Geographic hierarchy for agent assignment (AC2, AC7)
model Zone {
  id                Int      @id @default(autoincrement())
  name              String   @db.VarChar(100)
  type              ZoneType
  parentZoneId      Int?     @map("parent_zone_id")
  districtManagerId Int?     @map("district_manager_id") // User ID of DM managing this zone

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations - self-referential for hierarchy
  parentZone  Zone?                 @relation("ZoneHierarchy", fields: [parentZoneId], references: [id])
  childZones  Zone[]                @relation("ZoneHierarchy")
  assignments AgentZoneAssignment[]

  @@index([type])
  @@index([parentZoneId])
  @@map("zones")
}

// AgentZoneAssignment Model - Links agents to zones with history (AC3, AC7)
model AgentZoneAssignment {
  id            Int       @id @default(autoincrement())
  agentId       Int       @map("agent_id")
  zoneId        Int       @map("zone_id")
  assignedById  Int       @map("assigned_by") // District Manager who assigned
  effectiveFrom DateTime  @map("effective_from") @db.Date
  effectiveTo   DateTime? @map("effective_to") @db.Date // Null = current assignment

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  agent AgentProfile @relation(fields: [agentId], references: [id], onDelete: Cascade)
  zone  Zone         @relation(fields: [zoneId], references: [id])

  @@index([agentId])
  @@index([zoneId])
  @@map("agent_zone_assignments")
}
